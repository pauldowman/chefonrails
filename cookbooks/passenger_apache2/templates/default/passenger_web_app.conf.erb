<% protocols = %w(http) # TODO add config variable for HTTPS %>
<% protocols.each do | p | %>
<VirtualHost *:<%= p == "http" ? 80 : 443 %> >
  ServerName <%= @params[:allowed_hostnames].first %>
  ServerAlias <% (@params[:allowed_hostnames] + @params[:other_hostnames]).each do |a| %><%= "#{a}" %> <% end %>  
  DocumentRoot <%= @params[:docroot] %>

  RailsBaseURI /
  RailsEnv <%= @params[:rails_env] %>
  PassengerMaxPoolSize <%= node[:passenger][:max_pool_size] %>
  PassengerPreStart <%=p%>://<%= @params[:allowed_hostnames].first %>/warmup

  <Directory <%= @params[:docroot] %>>
    Options FollowSymLinks
    AllowOverride None
    Order allow,deny
    Allow from all
    PassengerMinInstances <%= node[:passenger][:min_instances] %>
  </Directory>

  LogLevel info
  ErrorLog <%= node[:apache][:log_dir] %>/<%= (p == "https" ? "ssl-" : "") + @params[:name] %>-error.log
  CustomLog <%= node[:apache][:log_dir] %>/<%= (p == "https" ? "ssl-" : "") +  @params[:name] %>-access.log combined

  RewriteEngine On
  RewriteLog <%= node[:apache][:log_dir] %>/<%= @application_name %>-rewrite.log
  RewriteLogLevel 0
  
  # Ensure we're using one of the allowed hostnames
  <% @params[:allowed_hostnames].each do |h| -%>
  RewriteCond %{HTTP_HOST}   !^<%= h %> [NC]
  <% end -%>
  RewriteCond %{HTTP_HOST}   !^$
  RewriteRule ^/(.*)$        <%=p%>://<%= @params[:allowed_hostnames].first %>/$1 [L,R=301]

  RewriteCond %{DOCUMENT_ROOT}/system/maintenance.html -f
  RewriteCond %{SCRIPT_FILENAME} !maintenance.html
  RewriteRule ^.*$ /system/maintenance.html [L]

  <% if p == "https" %>
  SSLEngine On
  SSLCertificateKeyFile /etc/apache2/ssl/app1.com.key
  SSLCertificateFile /etc/apache2/ssl/app1.com.crt
  SSLCertificateChainFile /etc/apache2/ssl/cert_chain.crt
  <% end %>
</VirtualHost>
<% end %>
