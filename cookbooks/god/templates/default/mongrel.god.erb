# Generated by Chef

mongrel_list = Array.new
Dir["/etc/sv/mongrel-<%= @name %>-*"].each do |file|
  file =~ /mongrel-(.+)-(\d+)/
  group = $1
  port = $2
  mongrel = Hash.new
  mongrel[:name] = "#{group}-#{port}"
  mongrel[:start] = "<%= @sv_bin %> start #{file}"
  mongrel[:stop] = "<%= @sv_bin %> stop #{file}"
  mongrel[:restart] = "<%= @sv_bin %> restart #{file}"
  mongrel[:pidfile] = File.join(file, "supervise", "pid")
  mongrel[:port] = port
  mongrel_list << mongrel
end

mongrel_list.each do |mongrel|
  God.watch do |w|
    w.name = mongrel[:name]
    w.interval = 30.seconds # default      
    w.start = mongrel[:start] 
    w.stop = mongrel[:stop]
    w.restart = mongrel[:restart]
    w.start_grace = 10.seconds
    w.restart_grace = 10.seconds
    w.pid_file = mongrel[:pidfile] 

    w.restart_if do |restart|
      restart.condition(:memory_usage) do |c|
        c.above = <%= @max_memory %>.megabytes
      end

      restart.condition(:cpu_usage) do |c|
        c.above = <%= @cpu %>.percent
        c.times = 5
      end
    end
  end
end
